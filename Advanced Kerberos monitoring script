$domainControllers = Get-ADDomainController -Filter *

foreach ($dc in $domainControllers) {
    Write-Host "Searching for long-lived TGTs on $($dc.Name)..."
    Get-WinEvent -ComputerName $dc.Name -LogName "Security" -FilterHashtable @{
        Logname = 'Security'
        ID = 4768 # Kerberos Authentication Service Ticket Granted (TGT)
    } -MaxEvents 1000 | ForEach-Object {
        $eventXml = [xml]$_.ToXml()
        $ticketLifetime = $eventXml.Event.EventData.Data | Where-Object { $_.Name -eq "TicketOptions" }
        $endTime = $eventXml.Event.EventData.Data | Where-Object { $_.Name -eq "TicketGrantedTime" }
        
        # In a genuine Golden Ticket attack, a normal 10-hour lifetime may be used.
        # However, checking the ticket's actual end time can reveal anomalies.
        # This is an example; real-world detection requires fine-tuning.
        if ($ticketLifetime -and $ticketLifetime.Value -like "*Renewable*") {
            Write-Warning "Potentially suspicious long-lived TGT detected on $($dc.Name):"
            Write-Host "  Time: $($_.TimeCreated)"
            Write-Host "  Target Account: $($eventXml.Event.EventData.Data[1].'#text')"
        }
    }
}
