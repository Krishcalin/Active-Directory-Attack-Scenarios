$domainControllers = Get-ADDomainController -Filter *

foreach ($dc in $domainControllers) {
    Write-Host "Searching for RC4 encryption downgrade on $($dc.Name)..."
    Get-WinEvent -ComputerName $dc.Name -LogName "Security" -FilterHashtable @{
        Logname = 'Security'
        ID = 4769 # Kerberos Service Ticket Granted (TGS)
    } -MaxEvents 1000 | ForEach-Object {
        $eventXml = [xml]$_.ToXml()
        $encryptionType = $eventXml.Event.EventData.Data | Where-Object { $_.Name -eq "TicketEncryptionType" }

        # 0x17 corresponds to RC4 encryption. AES is more common.
        if ($encryptionType -and $encryptionType.Value -eq "0x17") {
            Write-Warning "Suspicious RC4 encryption type detected on $($dc.Name):"
            Write-Host "  Time: $($_.TimeCreated)"
            Write-Host "  Target Account: $($eventXml.Event.EventData.Data[1].'#text')"
        }
    }
}
