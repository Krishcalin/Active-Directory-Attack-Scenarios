$domainKerberosPolicy = (Get-ADDomain).KerberosPolicy
$maxTicketLifetimeMinutes = ($domainKerberosPolicy.'MaxTicketAge' / 600000000)
$scriptLifetimeInMinutes = 60 * 10
$maxExpectedEndtime = (Get-Date).AddMinutes($maxTicketLifetimeMinutes + $scriptLifetimeInMinutes)

$eventLog = Get-WinEvent -FilterHashtable @{
    Logname = 'Security'
    Id = 4769
    Level = 0
} -MaxEvents 10000 | ForEach-Object {
    $eventXML = [xml]$_.ToXml()
    $ticketEndTime = $eventXML.Event.EventData.Data | Where-Object {$_.Name -eq "TicketOptions"}
    
    if($ticketEndTime.value -gt $maxExpectedEndtime) {
        [PSCustomObject]@{
            TimeCreated     = $_.TimeCreated
            UserName        = $eventXML.Event.EventData.Data | Where-Object {$_.Name -eq "TargetUserName"}
            Domain          = $eventXML.Event.EventData.Data | Where-Object {$_.Name -eq "TargetDomainName"}
            TicketEndTime   = $ticketEndTime.value
            MaxExpected     = $maxExpectedEndtime
        }
    }
}
$eventLog
